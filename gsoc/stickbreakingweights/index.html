<!DOCTYPE html>
<html lang="en">

  <head>
    
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>

  Larry  Dong


  | Merged my first distribution class üéâ

</title>
<meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->
<!-- 
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî•</text></svg>">
 -->
<link rel="shortcut icon" type="image/png" href="/assets/img/favicon.png">
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="https://larryshamalama.github.io/gsoc/stickbreakingweights/">


<!-- Dark Mode -->
<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="https://larryshamalama.github.io/">
       <span class="font-weight-bold">Larry</span>   Dong
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          <!-- Blog -->
          <!-- 
          <li class="nav-item active">
            <a class="nav-link" href="/gsoc/">
              gsoc
              
            </a>
          </li>
           -->
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/posts/">
                posts
                
              </a>
          </li>
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/research/">
                research
                
              </a>
          </li>
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/resources/">
                resources
                
              </a>
          </li>
          
          
          
          
          
          
          
          
            <div class="toggle-container">
              <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      <div class="post">

  <header class="post-header">
    
      <h1 class="post-title">Merged my first distribution class üéâ</h1>
    
    <p class="post-description">The first step to Dirichlet processes</p>
  </header>

  <article>
    <p>Link to pull request: <a href="https://github.com/pymc-devs/pymc/pull/5200" target="_blank" rel="noopener noreferrer">https://github.com/pymc-devs/pymc/pull/5200</a></p>

<p>After a long (two month) process, my PR on adding a distribution class has been merged! üôÇ The whole process of taking the initiative to contribute to PyMC was rewarding, but definitely not easy.</p>

<h3 id="revisiting-dirichlet-processes">Revisiting Dirichlet Processes</h3>

<p>A random distribution \(G\) has a Dirichlet Process (DP) prior, denoted by \(G \sim \text{DP}(\alpha, G_0)\) if any finite partition \(\{A_i\}_{i=1}^n\) of the sample space \(\Theta\) follows a Dirichlet distribution as such:</p>

\[\Big(G(A_1), \dots, G(A_n) \Big) \sim \text{Dir}\Big(\alpha G_0(A_1), \dots, \alpha G_0(A_n) \Big)\]

<p>where \(\alpha &gt; 0\) is the concentration parameter and \(G_0\) is some base distribution, e.g. \(G_0 \equiv \mathcal{N}(0, 1)\). The higher the value of \(\alpha\), the smaller the weight values will be.</p>

<div class="row justify-content-sm-center">
    <div class="col-sm-8 mt-3 mt-md-0">
    </div>
    <div class="col-sm-8 mt-3 mt-md-0">
        <picture>
    
    <source media="(max-width: 480px)" srcset="/assets/resized/stick-breaking-weights-480x322.jpg"></source>
    
    <source media="(max-width: 800px)" srcset="/assets/resized/stick-breaking-weights-800x537.jpg"></source>
    
    <source media="(max-width: 1400px)" srcset="/assets/resized/stick-breaking-weights-1400x940.jpg"></source>
    
    <img class="img-fluid rounded mx-auto d-block" src="/assets/img/stick-breaking-weights.jpg">
</picture>

    </div>
    <div class="col-sm-8 mt-3 mt-md-0">
    </div>
</div>
<div class="caption">
    Here is a visual depiction of how the weights are obtained from a stick-breaking construction. At each iteration, a weight is taken from the remainder of a stick, initially to be one unit long. Figure taken from <a href="https://discovery.ucl.ac.uk/id/eprint/20467/1/20467.pdf" target="_blank" rel="noopener noreferrer">Sivakumar Murugiah's thesis</a>.
</div>

<p>It can be initially difficult to understand why such a construction is useful, let alone nonparametric, but the idea is as followed. In Bayesian inference, we wish to perform inference by conditioning on observed data and looking at the posterior distribution of parameters of interest. However, by positing a DP prior on \(G\), we can effectively perform inference on the distribution \(G\) <em>without</em> positing any distributional assumption, hence rendering this construction nonparametric despite the need to specify \(G_0\). It is already worth mentioning that a DP prior poses some ‚Äústrong‚Äù restrictions, so a more common application of DPs are to posit them as priors in mixture modelling, but more on that at a later date‚Ä¶</p>

<p>When it comes to sampling, there are many schemas with desirable properties that provide nice (conditional)posterior distributions (see <a href="https://en.wikipedia.org/wiki/Chinese_restaurant_process" target="_blank" rel="noopener noreferrer">Chinese Restaurant Process</a> and <a href="https://en.wikipedia.org/wiki/P%C3%B3lya_urn_model" target="_blank" rel="noopener noreferrer">Polya Urn</a>). However, an inherent challenge to build a DP functionality to PyMC is to leverage its default sampling methods which are primarily gradient-based, i.e. Hamiltonian Monte Carlo (HMC) or some of its extensions if I remember correctly. As such, the most useful construction of a DP is to represent it as an infinite linear combination of weights obtained via a stick-breaking process and atoms, represented as Dirac delta distributions:</p>

\[G = \sum_{h=1}^\infty w_h \delta_{m_h}\]

<p>where \(w_h = v_h \prod_{\ell &lt; h} (1 - v_\ell)\) where \(v_h \stackrel{\text{i.i.d.}}{\sim} \text{Beta}(1, \alpha)\) and \(m_h \stackrel{\text{i.i.d.}}{\sim} G_0\). This construction is particularly helpful since it is more easily vectorizable and plays into the strengths of HMC. Of course, as taught in undergraduate calculus, infinity is a concept, not a number, and our computers couldn‚Äôt agree more. Instead of an infinite sum, we can express \(G\) using some large truncation parameter \(K\) and this finite approximation is justified by <a href="http://people.ee.duke.edu/~lcarin/Yuting3.3.06.pdf" target="_blank" rel="noopener noreferrer">Ishwaran and James (2001)</a>:</p>

\[G = \sum_{h=1}^K w_h \delta_{m_h} \, .\]

<p>From the same article, we have that the distribution of stick-breaking weights follows a generalized Dirichlet distribution, so that turns out to be the first step in implementing a submodule for DPs.</p>

<h3 id="randomvariable-classes-in-pymcaesara">
<code class="language-plaintext highlighter-rouge">RandomVariable</code> classes in PyMC/Aesara</h3>

<p>In PyMC, distributions are implemented as <code class="language-plaintext highlighter-rouge">Distribution</code> classes with <code class="language-plaintext highlighter-rouge">RandomVariable</code> instances <code class="language-plaintext highlighter-rouge">rv_op</code>. These <code class="language-plaintext highlighter-rouge">rv_op</code> have an <code class="language-plaintext highlighter-rouge">rng_fn</code> method that is able to generate samples from the prior distribution and it serves as the basis of <code class="language-plaintext highlighter-rouge">pm.sample_prior_predictive</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StickBreakingWeightsRV</span><span class="p">(</span><span class="n">RandomVariable</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">stick_breaking_weights</span><span class="sh">"</span>
    <span class="n">ndim_supp</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ndims_params</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="sh">"</span><span class="s">floatX</span><span class="sh">"</span>
    <span class="n">_print_name</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">StickBreakingWeights</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="se">\\</span><span class="s">operatorname{StickBreakingWeights}</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_node</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="nf">as_tensor_variable</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="nf">as_tensor_variable</span><span class="p">(</span><span class="nf">intX</span><span class="p">(</span><span class="n">K</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">alpha</span><span class="p">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">The concentration parameter needs to be a scalar.</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">K</span><span class="p">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">K must be a scalar.</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">return</span> <span class="nf">super</span><span class="p">().</span><span class="nf">make_node</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_infer_shape</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dist_params</span><span class="p">,</span> <span class="n">param_shapes</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">alpha</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">dist_params</span>

        <span class="n">size</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">size</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rng_fn</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">K</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">K needs to be positive.</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span><span class="p">,)</span>

        <span class="n">betas</span> <span class="o">=</span> <span class="n">rng</span><span class="p">.</span><span class="nf">beta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

        <span class="n">sticks</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">size</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))),</span>
                <span class="n">np</span><span class="p">.</span><span class="nf">cumprod</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">betas</span><span class="p">[...,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">sticks</span> <span class="o">*</span> <span class="n">betas</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weights</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[...,</span> <span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">]),</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">weights</span>
</code></pre></div></div>

<p>First, the distinction between <code class="language-plaintext highlighter-rouge">StickBreakingWeightsRV</code> and <code class="language-plaintext highlighter-rouge">StickBreakingWeights</code> is important as the latter is the one that will be used under a <code class="language-plaintext highlighter-rouge">pm.Model()</code> context manager. The <code class="language-plaintext highlighter-rouge">rng_fn</code> essentially follows the mathematical stick-breaking construction in that \(K\) i.i.d. draws from a \(\text{Beta}(1, \alpha)\) are used to construct \(w_1, \dots, w_{K}\) with \(w_{K+1} = 1 - \sum_{\ell=1}^K w_\ell\). An inherent challenge of this design is to abide by the existing OOP structure of the library since all the intricacies are not obvious. For instance, while <code class="language-plaintext highlighter-rouge">size</code> is used to specify the dimension of the observations that we want to sample (also in <code class="language-plaintext highlighter-rouge">StickBreakingWeights</code> below), we decided to provide the truncation parameter <code class="language-plaintext highlighter-rouge">K</code> as an explicit argument rather than include as part of <code class="language-plaintext highlighter-rouge">size</code> or <code class="language-plaintext highlighter-rouge">shape</code>.</p>

<h3 id="a-distribution-class-for-truncated-stick-breaking-weights">A distribution class for (truncated) stick-breaking weights</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StickBreakingWeights</span><span class="p">(</span><span class="n">Continuous</span><span class="p">):</span>
    <span class="c1"># rv_op instance defined as: stickbreakingweights = StickBreakingWeights()
</span>    <span class="n">rv_op</span> <span class="o">=</span> <span class="n">stickbreakingweights</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">.</span><span class="nf">setdefault</span><span class="p">(</span><span class="sh">"</span><span class="s">transform</span><span class="sh">"</span><span class="p">,</span> <span class="n">transforms</span><span class="p">.</span><span class="n">simplex</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">super</span><span class="p">().</span><span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="nf">as_tensor_variable</span><span class="p">(</span><span class="nf">floatX</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="nf">as_tensor_variable</span><span class="p">(</span><span class="nf">intX</span><span class="p">(</span><span class="n">K</span><span class="p">))</span>

        <span class="nf">assert_negative_support</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="sh">"</span><span class="s">alpha</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">StickBreakingWeights</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">assert_negative_support</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="sh">"</span><span class="s">K</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">StickBreakingWeights</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">return</span> <span class="nf">super</span><span class="p">().</span><span class="nf">dist</span><span class="p">([</span><span class="n">alpha</span><span class="p">,</span> <span class="n">K</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_moment</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
        <span class="n">moment</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">))</span> <span class="o">**</span> <span class="n">at</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
        <span class="n">moment</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">moment</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">moment</span><span class="p">,</span> <span class="p">[(</span><span class="n">alpha</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">))</span> <span class="o">**</span> <span class="n">K</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">rv_size_is_none</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="n">moment_size</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">size</span><span class="p">,</span>
                    <span class="p">[</span>
                        <span class="n">K</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">moment</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="nf">full</span><span class="p">(</span><span class="n">moment_size</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">moment</span>

    <span class="k">def</span> <span class="nf">logp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Calculate log-probability of the distribution induced from the stick-breaking process
        at specified value.

        Parameters
        ----------
        value: numeric
            Value for which log-probability is calculated.

        Returns
        -------
        TensorVariable
        </span><span class="sh">"""</span>
        <span class="n">logp</span> <span class="o">=</span> <span class="o">-</span><span class="n">at</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span>
            <span class="n">at</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span>
                <span class="n">at</span><span class="p">.</span><span class="nf">cumsum</span><span class="p">(</span>
                    <span class="n">value</span><span class="p">[...,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logp</span> <span class="o">+=</span> <span class="o">-</span><span class="n">K</span> <span class="o">*</span> <span class="nf">betaln</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">logp</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">at</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">value</span><span class="p">[...,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">logp</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="nf">switch</span><span class="p">(</span>
            <span class="n">at</span><span class="p">.</span><span class="nf">or_</span><span class="p">(</span>
                <span class="n">at</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span>
                    <span class="n">at</span><span class="p">.</span><span class="nf">and_</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="nf">le</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">at</span><span class="p">.</span><span class="nf">ge</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                    <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">at</span><span class="p">.</span><span class="nf">or_</span><span class="p">(</span>
                    <span class="n">at</span><span class="p">.</span><span class="nf">bitwise_not</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="nf">allclose</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)),</span>
                    <span class="n">at</span><span class="p">.</span><span class="nf">neq</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">K</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">,</span>
            <span class="n">logp</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="nf">check_parameters</span><span class="p">(</span>
            <span class="n">logp</span><span class="p">,</span>
            <span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">msg</span><span class="o">=</span><span class="sh">"</span><span class="s">alpha &gt; 0, K &gt; 0</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></div>

<p>The length of this <code class="language-plaintext highlighter-rouge">Distribution</code> class may seem a bit daunting, but here is a summary of each method.</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">__new__</code>: Here, we suggest the default transformation that would help sampling. Because each weight is between 0 and 1, the range of the transformed ‚Äúweight‚Äù is not \(\mathbb{R}\) so the sampler cannot go into ‚Äúdanger‚Äù territories.</li>
  <li>
<code class="language-plaintext highlighter-rouge">dist</code>: It is a bottleneck method which takes inputs that parametrize the distribution. At this point, inputs can be ‚Äúanything‚Äù, i.e. they have not necessarily been transformed into <code class="language-plaintext highlighter-rouge">aesara.tensor.var.TensorVariable</code> instances yet.</li>
  <li>
<code class="language-plaintext highlighter-rouge">get_moment</code>: An approach that PyMC has recently taken is to initialize samplers at the mean of each distribution (with no observations). For that purpose, <code class="language-plaintext highlighter-rouge">get_moment</code> has been introduced and, given that stick-breaking weights are a product of linear transformations of i.i.d. Beta random variables, we have that:</li>
</ul>

\[\mathbb{E}\left[w_h\right] = \frac{1}{1 + \alpha}\left(\frac{\alpha}{1 + \alpha}\right)^{h - 1}\]

<p>for all \(h = 1, \dots, K\) and \(\mathbb{E}\left[w_{K+1}\right] = \left(\frac{\alpha}{1 + \alpha}\right)^{K}\).</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">logp</code>: While it may seem naive, this is the most important method as this is exactly what allows <code class="language-plaintext highlighter-rouge">pm.sample()</code> to do its magic. Here, I provide the log distribution of a generalized Dirichlet distribution with \(b_h = 1\) and \(a_h = \alpha\) for all \(h\) with respect to the density provided in the <a href="https://en.wikipedia.org/wiki/Generalized_Dirichlet_distribution" target="_blank" rel="noopener noreferrer">Wiki article</a>. Note that we assume that <code class="language-plaintext highlighter-rouge">value</code> can be of any dimension. Everything else in the method (what‚Äôs in <code class="language-plaintext highlighter-rouge">at.switch</code> and <code class="language-plaintext highlighter-rouge">check_parameters</code>) are to ensure that inputs and parameters are all valid with respect to the distribution‚Äôs constraints; errors would be raised if we provided something like <code class="language-plaintext highlighter-rouge">alpha = -2</code>, for instance.</li>
</ul>

<p>A small comment that I added unit tests regarding this distribution: testing shapes, <code class="language-plaintext highlighter-rouge">logp</code>, <code class="language-plaintext highlighter-rouge">rng_fn</code> and their extensions to multidimensional samples. I do not talk about them here, but unit tests are quite important and, given that I didn‚Äôt know what they were before, it was an interesting learning experience.</p>

<h3 id="some-final-comments">Some final comments</h3>

<p>As I am pursuing a PhD, this experience of contributing to open source has been extremely rewarding and educational. It was not an easy process, but it was enjoyable, as I was able to learn a lot about the process of ‚Äúproperly‚Äù contributing code (in quotation marks because I am no software engineer and who am I to say that this is the proper method although this is the by far most structure that I have ever experienced).</p>

<p>The next steps are to properly simulate data from a DP to better understand how we should go about building an API for it. The ultimate goal is to have a working submodule and a nice class for DP Mixtures, which will probably be the most useful extension of DPs in practice.</p>

<h3 id="thanks">Thanks</h3>

<p>Firstly, a big thanks to you for reading this post! While this was a nice exercise for myself, it‚Äôs nice to have people read on my work (and comment on it if you want!). I am proud to have coded everything, but none of this was possible without the help of these amazing people, who were always there to share their ideas and comments about my code:</p>

<ul>
  <li><a href="https://austinrochford.com/" target="_blank" rel="noopener noreferrer">Austin Rochford</a></li>
  <li><a href="https://twitter.com/fonnesbeck" target="_blank" rel="noopener noreferrer">Chris Fonnesbeck</a></li>
  <li><a href="https://github.com/ricardoV94/" target="_blank" rel="noopener noreferrer">Ricardo Vieira</a></li>
</ul>

<p>Last but not least, a big thanks to the entire PyMC community for answering all my questions and all their ongoing efforts, whether they are noticeable or not üöÄ</p>

  </article>

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    ¬© Copyright 2023 Larry  Dong.
    Powered by <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>.

    
    
  </div>
</footer>



  </body>

  <!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>

  
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  





</html>
